<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="cropped_circle_image.png">
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; direction: rtl; }
#map { height: 100%; width: 100%; }
.info-box {
  position: absolute; bottom: 20px; right: 20px;
  background: black; color: white; padding: 10px;
  border-radius: 8px; max-width: 400px;
  line-height: 1.4em; z-index: 1000;
  display: none; overflow-y: auto; max-height: 200px;
}
.logo-overlay {
  position: absolute; top: 10px; left: 10px;
  width: 60px; height: 60px; border-radius: 50%;
  overflow: hidden; z-index: 1000;
  pointer-events: none; border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }

#sound-box {
  position: absolute; top: 20px; right: 20px;
  background: #111; color: white;
  padding: 15px; border-radius: 12px;
  z-index: 1001; display: block; max-width: 320px;
  font-size: 14px;
}
#sound-box h4 {
  margin: 8px 0 4px 0; font-size: 15px; border-bottom: 1px solid #333;
  padding-bottom: 2px; color: #ffd700;
}
#sound-box label, #sound-box select, #sound-box button {
  display: block; margin-top: 5px; width: 100%;
}
#sound-box button { margin-top: 10px; cursor: pointer; }
#notifyPermission { margin-left: 6px; }

/* ×—×™×¤×•×© ×™×™×©×•×‘×™× */
#city-search-container { margin-top: 10px; position: relative; }
#city-search {
  width: 100%; padding: 6px 8px;
  border-radius: 6px; border: none;
  outline: none; font-size: 14px;
}
#city-search::placeholder { color: #aaa; }
#suggestions {
  position: absolute; top: 100%; right: 0;
  background: #222; color: white;
  width: 100%; border-radius: 6px;
  max-height: 180px; overflow-y: auto;
  display: none; z-index: 2000;
}
.suggestion {
  padding: 6px 8px; cursor: pointer;
  border-bottom: 1px solid #333;
}
.suggestion small { display: block; color: #bbb; font-size: 12px; }
.suggestion:hover { background: #333; }

/* ×¢×¨×™× × ×‘×—×¨×•×ª */
#selected-cities {
  margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;
}
.city-tag {
  background: #444; color: white;
  padding: 4px 8px; border-radius: 8px;
  font-size: 13px; display: flex; align-items: center; gap: 4px;
}
.city-tag span {
  cursor: pointer; color: #ff6666;
  font-weight: bold;
}
#city-actions { margin-top: 6px; display: flex; gap: 6px; }
#city-actions button {
  flex: 1; padding: 5px; border: none;
  border-radius: 6px; cursor: pointer;
}
#save-cities { background: #28a745; color: white; }
#clear-cities { background: #dc3545; color: white; }
</style>
</head>
<body>
<div id="map"></div>
<div class="logo-overlay"><img src="cropped_circle_image.png" alt="Logo"></div>
<div id="alert-box" class="info-box"></div>

<div id="sound-box">
  <div id="datetime" style="color:white;font-weight:bold;"></div>

  <h4>×¦×œ×™×œ ×”×ª×¨×¢×”</h4>
  <select id="sound-select">
    <option value="none" selected>×œ×œ×</option>
    <option value="alert">×”×ª×¨×¢×”</option>
    <option value="calm">×¨×’×•×¢</option>
    <option value="siren">××–×¢×§×”</option>
    <option value="homefront">×¤×™×§×•×“ ×”×¢×•×¨×£</option>
    <option value="beep">×¦×¤×¦×•×£</option>
  </select>
  <button id="sound-btn" style="display:none;">×‘×“×•×§</button>

  <h4>×”×ª×¨××•×ª ×‘×“×¤×“×¤×Ÿ</h4>
  <label style="margin-top:10px;cursor:pointer;">
    <input type="checkbox" id="notifyPermission"> ××¤×©×¨ ×§×‘×œ×ª ×”×ª×¨×¢×•×ª ×‘×“×¤×“×¤×Ÿ
  </label>

  <h4>×‘×—×¨ ×™×™×©×•×‘</h4>
  <div id="city-search-container">
    <input type="text" id="city-search" placeholder="×‘×—×¨ ×™×™×©×•×‘ ×œ×§×‘×œ ×¢×œ×™×• ×”×ª×¨×¢×”">
    <div id="suggestions"></div>
  </div>
  <div id="selected-cities"></div>
  <div id="city-actions">
    <button id="save-cities">×©××•×¨</button>
    <button id="clear-cities">× ×§×”</button>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map;
let cityCoordinates = {};
let markers = [];
let cityPolygons = {};
let activePolygons = [];
let audio = null;
let audioTimeout = null;
let alertActive = false;

// ×¡××•× ×“×™×
const sounds = {
  calm: "calm.mp3", siren: "alert.mp3",
  homefront: "homefront.mp3", alert: "siren.mp3", beep: "beep.wav"
};

// ×”×¨×©××•×ª ×”×ª×¨××•×ª
let desktopPermissionGranted = false;
document.getElementById("notifyPermission").addEventListener("change", function() {
  if (this.checked && "Notification" in window) {
    Notification.requestPermission().then(permission => {
      desktopPermissionGranted = permission === "granted";
    });
  } else { desktopPermissionGranted = false; }
});

// ×¨×©×™××ª ×™×™×©×•×‘×™× ×©× ×‘×—×¨×•
let selectedCities = [];
let citiesDataGlobal = null;

// ×ª×¦×•×’×” - ×¢×¨×™× × ×‘×—×¨×•×ª
function renderSelectedCities() {
  const container = document.getElementById("selected-cities");
  container.innerHTML = "";
  selectedCities.forEach(city => {
    const tag = document.createElement("div");
    tag.className = "city-tag";
    tag.innerHTML = `${city} <span data-city="${city}">âœ–</span>`;
    container.appendChild(tag);
  });
  container.querySelectorAll("span").forEach(span=>{
    span.addEventListener("click", ()=>{
      selectedCities = selectedCities.filter(c=>c!==span.dataset.city);
      renderSelectedCities();
    });
  });
}

// autocomplete
function setupAutocomplete(citiesData) {
  const input = document.getElementById("city-search");
  const suggestionsBox = document.getElementById("suggestions");

  input.addEventListener("input", ()=>{
    const value = input.value.trim();
    suggestionsBox.innerHTML = "";
    if (!value) { suggestionsBox.style.display = "none"; return; }

    const results = Object.values(citiesData.cities)
      .filter(c => c.he.startsWith(value) && /^[×-×ª]/.test(c.he))
      .sort((a,b)=>a.he.localeCompare(b.he))
      .slice(0,8);

    if (results.length === 0) { suggestionsBox.style.display = "none"; return; }

    results.forEach(c=>{
      const div = document.createElement("div");
      div.className = "suggestion";
      div.innerHTML = `${c.he}<small>${citiesData.areas[c.area]?.he || ""}</small>`;
      div.addEventListener("click", ()=>{
        if (selectedCities.includes(c.he)) return;
        if (selectedCities.length >= 5) { alert("××¤×©×¨ ×œ×‘×—×•×¨ ×¢×“ 5 ×™×™×©×•×‘×™× ×‘×œ×‘×“"); return; }
        selectedCities.push(c.he);
        renderSelectedCities();
        input.value = "";
        suggestionsBox.style.display="none";
      });
      suggestionsBox.appendChild(div);
    });
    suggestionsBox.style.display = "block";
  });
}

// ×©××™×¨×” / × ×™×§×•×™
document.getElementById("save-cities").addEventListener("click", ()=> {
  alert("×”×¢×¨×™× × ×©××¨×• ×œ×”×¢×“×¤×•×ª ×”×¡×™× ×•×Ÿ (×¨×¢× ×•×Ÿ ×”×“×£ ×™××¤×¡)");
});
document.getElementById("clear-cities").addEventListener("click", ()=> {
  selectedCities = []; renderSelectedCities();
});

// ×ª××¨×™×š ×•×©×¢×”
function updateDateTime() {
  const now = new Date();
  const options = {timeZone:'Asia/Jerusalem', hour12:false};
  document.getElementById("datetime").textContent =
    `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;
}
setInterval(updateDateTime,1000); updateDateTime();

// ×˜×¢×™× ×ª JSONs
Promise.all([
  fetch('citiess.json').then(res => res.json()),
  fetch('cleaned_fine.json').then(res => res.json())
]).then(([citiesData, polygonsData]) => {
  citiesDataGlobal = citiesData;
  Object.values(citiesData.cities).forEach(c => { cityCoordinates[c.he]={lat:c.lat,lng:c.lng}; });
  if(!map) initMap();
  setupAutocomplete(citiesData);

  // ×¤×•×œ×™×’×•× ×™×
  Object.keys(polygonsData).forEach(city=>{
    const pathCoords = polygonsData[city].map(coord=>({lat:coord[0], lng:coord[1]}));
    cityPolygons[city] = new google.maps.Polygon({
      paths: pathCoords, strokeColor: '#000000', strokeOpacity:1.0,
      strokeWeight:2, fillColor:'red', fillOpacity:0.4, map:null
    });
  });

  // ×”××–× ×” ×œ×”×ª×¨×¢×•×ª
  db.ref("messages").on("child_added", snapshot=>{
    const data=snapshot.val();
    if(!data||!data.text||!data.timestamp) return;
    const msgTime=new Date(data.timestamp);
    const now=new Date();
    if(now-msgTime>60*1000) return;

    const message = data.text;
    let settlements = new Set();

    message.split("\n").forEach(line=>{
      if(line.startsWith("â€¢")){
        let parts=line.split(":");
        if(parts.length>1){
          parts[1].split(",").forEach(city=>{
            let cleanCity=city.replace(/\(.*?\)/g,"").trim();
            if(citiesData.cities[cleanCity]) settlements.add(cleanCity);
          });
        }
      }
    });

    const citiesInMessage = Array.from(settlements);

    // ×¡×™× ×•×Ÿ ×œ×¤×™ ×‘×—×™×¨×ª ×”××©×ª××©
    if (selectedCities.length > 0 && !citiesInMessage.some(c => selectedCities.includes(c))) {
      console.log("â­ï¸ ×”×ª×¨×¢×” ×¡×•× × ×” ×›×™ ×œ× × ×•×’×¢×ª ×œ×™×™×©×•×‘×™× ×©× ×‘×—×¨×•");
      return;
    }

    if(citiesInMessage.length>0){
      // ×”×¦×’×ª ×”×•×“×¢×”
      const alertBox = document.getElementById('alert-box');
      alertBox.innerHTML = message.replace(/\n/g, "<br>");
      alertBox.style.display='block';
      setTimeout(()=>{ alertBox.style.display='none'; },10000);

      // ×¡××•× ×“
      if(audio){ audio.pause(); audio=null; clearTimeout(audioTimeout); }
      if(soundSelect.value!=="none"){
        audio=new Audio(sounds[soundSelect.value]); audio.loop=true; audio.play();
        audioTimeout=setTimeout(()=>{ audio.pause(); audio=null; },8000);
      }

      // ××¨×§×¨×™×
      citiesInMessage.forEach(city=>{
        if(cityPolygons[city]) cityPolygons[city].setMap(map);
        const coords = cityCoordinates[city];
        if(coords) addFlashingMarker(coords.lat, coords.lng, message);
      });
    }
  });

});

// ××¤×”
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8}, zoom: 7,
    mapTypeId: 'roadmap', disableDefaultUI: true
  });
}

// ×¤×œ××© ××¨×§×¨×™×
function addFlashingMarker(lat, lng, message) {
  const marker = new google.maps.Marker({position: {lat, lng}, map, title: message});
  markers.push(marker);
  let visible = true;
  const flashInterval = setInterval(() => { marker.setVisible(visible); visible=!visible; }, 600);
  setTimeout(() => { marker.setMap(null); clearInterval(flashInterval); markers = markers.filter(m => m !== marker); }, 10000);
}

window.initMap = initMap;
</script>
</body>
</html>
