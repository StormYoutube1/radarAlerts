<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>מפת התרעות ישראל</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
      direction: rtl;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .info-box {
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- Google Maps JS API -->
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map;
let cityCoordinates = {};
let knownCities = [];
let currentMarker = null;
let flashInterval = null;
const FLASH_DURATION = 10000; // 10 שניות

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true,
    draggable: false,
    scrollwheel: false,
    disableDoubleClickZoom: true,
    keyboardShortcuts: false
  });
}

function addFlashingMarker(lat, lng, message) {
  if (currentMarker) currentMarker.setMap(null);
  if (flashInterval) clearInterval(flashInterval);

  currentMarker = new google.maps.Marker({
    position: {lat, lng},
    map: map,
    title: message
  });

  let visible = true;
  flashInterval = setInterval(() => {
    currentMarker.setVisible(visible);
    visible = !visible;
  }, 600);

  const infowindow = new google.maps.InfoWindow({content: `<div class="info-box">${message}</div>`});
  currentMarker.addListener("click", () => infowindow.open(map, currentMarker));

  // זום למיקום ההתרעה
  map.setCenter({lat, lng});
  map.setZoom(12);

  // הסרת ההתרעה אחרי 10 שניות וחזרה למפה רגילה
  setTimeout(() => {
    if (currentMarker) currentMarker.setMap(null);
    if (flashInterval) clearInterval(flashInterval);
    currentMarker = null;
    flashInterval = null;
    map.setCenter({lat: 31.5, lng: 34.8});
    map.setZoom(7);
  }, FLASH_DURATION);
}

function extractCities(text, knownCities) {
  const cities = [];
  for (const city of knownCities) {
    if (text.includes(city)) cities.push(city);
  }
  return cities;
}

// טעינת קואורדינטות
fetch('citiess.json')
  .then(response => response.json())
  .then(data => {
    const citiesData = data.cities;
    for (const key in citiesData) {
      cityCoordinates[citiesData[key].he] = {
        lat: citiesData[key].lat,
        lng: citiesData[key].lng
      };
    }
    knownCities = Object.keys(cityCoordinates);

    if (!map) initMap();

    db.ref("messages").on("child_added", snapshot => {
      const data = snapshot.val();
      if (!data || !data.text || !data.timestamp) return;

      // בדיקה אם ההודעה מהדקה האחרונה בישראל (UTC+3)
      const msgTime = new Date(data.timestamp);
      const now = new Date();
      const diffMs = now - msgTime; // במילישניות
      if (diffMs > 60*1000) return; // רק דקה אחרונה

      const message = data.text;
      const cities = extractCities(message, knownCities);

      for (const city of cities) {
        const coords = cityCoordinates[city];
        if (coords) addFlashingMarker(coords.lat, coords.lng, message);
      }
    });
  })
  .catch(err => console.error('Error loading cities JSON:', err));

window.initMap = initMap;
</script>
</body>
</html>
