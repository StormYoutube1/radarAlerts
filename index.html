<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>专专  - 爪注 </title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="cropped_circle_image.png">
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; direction: rtl; }
#map { height: 100%; width: 100%; }

.info-box {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: black;
  color: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 400px;
  line-height: 1.4em;
  z-index: 1000;
  display: none;
  overflow-y: auto;
  max-height: 200px;
}

.logo-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  z-index: 1000;
  pointer-events: none;
  border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }

#sound-box {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(17,17,17,0.95);
  color: white;
  padding: 15px;
  border-radius: 15px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.4);
  z-index: 1001;
  width: 300px;
  max-height: 500px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

#sound-box label, #sound-box select, #sound-box button {
  display: block;
  margin-top: 5px;
}
#sound-box button { margin-top: 10px; }

#selected-cities {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 120px;
  overflow-y: auto;
  padding-right: 3px;
}

.selected-city {
  background: #222;
  border-radius: 6px;
  padding: 5px 8px;
  font-size: 14px;
  line-height: 1.3em;
}

.selected-city strong { display: block; }
.selected-city small { color: #aaa; font-size: 12px; display: block; margin-top: 2px; }

.selected-city span.remove {
  cursor: pointer;
  color: #f55;
  margin-right: 6px;
  font-weight: bold;
  float: left;
}

#city-search {
  width: calc(100% - 12px);
  padding: 6px 10px;
  border-radius: 8px;
  border: none;
  outline: none;
  font-size: 14px;
}

#city-suggestions {
  background: rgba(34,34,34,0.95);
  border-radius: 8px;
  max-height: 180px;
  overflow-y: auto;
  padding: 5px;
  width: 100%;
  position: relative;
  z-index: 2000;
}

.suggestion-item {
  padding: 6px 8px;
  cursor: pointer;
  border-radius: 6px;
  margin-bottom: 2px;
}
.suggestion-item:hover { background: #444; }

.suggestion-city { font-weight: bold; }
.suggestion-area { font-size: 12px; color: #aaa; }

@media (max-width: 600px) {
    #sound-box {
        width: 90%;
        right: 50%;
        transform: translateX(50%);
        top: auto;
        bottom: 20px;
        max-height: 50vh;
    }
    .logo-overlay {
        top: 10px;
        right: 10px;
        left: auto;
        width: 50px;
        height: 50px;
    }
    #alert-box {
        bottom: 90px;
        right: 10px;
        max-width: 90%;
    }
    #city-suggestions,
    #city-search,
    #selected-cities {
        display: none;
    }

    /*  砖  : 转转 住 砖 住 */
    #sound-box label input#soundMobileCheckbox {
        display: block;
    }
}

@media (max-width: 900px) and (min-width: 601px) {
    #sound-box {
        width: 300px;
        right: 10px;
        top: auto;
        bottom: 20px;
        max-height: 70vh;
    }
    .logo-overlay {
        top: 10px;
        right: 10px;
        left: auto;
    }
}

@media (min-width: 901px) {
    #sound-box {
        right: 20px;
        top: 20px;
        width: 300px;
        max-height: 500px;
    }
}
</style>
</head>
<body>
<div id="map"></div>
<div class="logo-overlay"><img src="cropped_circle_image.png" alt="Logo"></div>
<div id="alert-box" class="info-box"></div>

<div id="sound-box">
  <div id="datetime" style="color:white;font-weight:bold;"></div>
  <label for="sound-select">专 爪 转专注:</label>
  <select id="sound-select">
    <option value="none" selected></option>
    <option value="alert">转专注</option>
    <option value="calm">专注</option>
    <option value="siren">注拽</option>
    <option value="homefront">驻拽 注专祝</option>
    <option value="beep">爪驻爪祝</option>
  </select>
  <button id="sound-btn" style="display:none;">拽</button>

  <!--  转转 住 拽转 砖专转 拽  砖 -->
  <label style="margin-top:10px;cursor:pointer;">
    <input type="checkbox" id="notifyPermission"> 驻砖专 拽转 转专注转 驻驻
  </label>

  <!--  转 住祝  转转 住 住   转专爪 -->
  <label style="margin-top:10px;cursor:pointer; display:none;">
    <input type="checkbox" id="soundMobileCheckbox"> 驻注 爪 转专注 
  </label>

  <input type="text" id="city-search" placeholder="拽 砖  拽 转专注转 专拽 注专...">
  <div id="city-suggestions"></div>
  <div id="selected-cities"></div>
  <div style="margin-top:auto; text-align:center; padding-top:10px;">
      <div style="border-top:1px solid #555; padding-top:5px; color:#ff4444; font-weight:bold;">
          专专  - 爪注 
      </div>
      <div style="border-top:1px solid #555; padding-top:10px; display:flex; justify-content:center; margin-top:10px;">
          <button onclick="window.location.href='platform.html'"
                  style="padding:6px 12px; border:none; border-radius:6px; background:#444; color:white; cursor:pointer;">
            驻驻专转 砖
          </button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he&callback=initMap">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map, cityCoordinates = {}, validAreas = [], markers = [], cityPolygons = {}, activePolygons = [], audio = null, audioTimeout = null, alertActive = false, alertTimeout = null;
let desktopPermissionGranted = false;
let selectedCities = [];

const sounds = { calm: "calm.mp3", siren: "alert.mp3", homefront: "homefront.mp3", alert: "siren.mp3", beep: "beep.wav" };

// --- 专砖转 转专转 ---
const notifyCheckbox = document.getElementById("notifyPermission");
function updateNotifyCheckbox() {
  desktopPermissionGranted = Notification.permission === "granted";
  
  notifyCheckbox.checked = false;
  notifyCheckbox.disabled = Notification.permission !== "default" && Notification.permission !== "granted";
}
notifyCheckbox.addEventListener("change", function() {
  if (this.checked && "Notification" in window) {
    Notification.requestPermission().then(permission => {
      desktopPermissionGranted = permission === "granted";
      if (!desktopPermissionGranted) this.checked = false;
    });
  } else {
    desktopPermissionGranted = false;
  }
});
updateNotifyCheckbox();

// --- 爪转 转专 住拽驻 ---
function showDesktopNotification(message, citiesInMessage, citiesData) {
  if (!desktopPermissionGranted) return;
  const firstLine = message.split("\n").find(l => l.trim() !== "");
  const title = firstLine || " 转专注";

  const areasSet = new Set();
  citiesInMessage.forEach(city => {
    const cityObj = Object.values(citiesData.cities).find(c => c.he === city);
    if (cityObj && cityObj.area) {
      const areaId = cityObj.area;
      const areaName = citiesData.areas[areaId]?.he;
      if (areaName) areasSet.add(areaName);
    }
  });
  const areasList = Array.from(areasSet).sort((a,b)=> a.localeCompare(b, 'he')).join(", ");

  const now = new Date();
  const options = { timeZone: 'Asia/Jerusalem', hour12:false };
  const dateTimeStr = `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;

  const body = `${areasList}\n\n${dateTimeStr}\n\n专专  - 爪注 `;

  const notification = new Notification(title, { body: body, icon: 'cropped_circle_image.png' });
  notification.onclick = () => window.focus();
}

// --- 驻 ---
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true
  });
}

// --- 驻砖 专拽专 ---
function addFlashingMarker(lat, lng, message) {
  const marker = new google.maps.Marker({position: {lat, lng}, map, title: message});
  markers.push(marker);
  let visible = true;
  const flashInterval = setInterval(() => { marker.setVisible(visible); visible = !visible; }, 600);
  setTimeout(() => { marker.setMap(null); clearInterval(flashInterval); markers = markers.filter(m => m!==marker); }, 10000);
}

// --- 住 ---
const soundSelect = document.getElementById("sound-select");
const soundBtn = document.getElementById("sound-btn");
function updateSoundButton() { soundBtn.style.display = soundSelect.value==="none"?"none":"block"; soundBtn.textContent="拽"; }
soundSelect.addEventListener("change", updateSoundButton);
function toggleSound() {
  const selected = soundSelect.value;
  if(selected==="none") return;
  if(audio){ audio.pause(); audio=null; clearTimeout(audioTimeout); soundBtn.textContent="拽"; } 
  else{ audio=new Audio(sounds[selected]); audio.loop=true; audio.play(); soundBtn.textContent="注爪专";
    audioTimeout=setTimeout(()=>{ audio.pause(); audio=null; soundBtn.textContent="拽"; },8000);
  }
}
soundBtn.addEventListener("click", toggleSound);

// --- 转专 砖注 ---
function updateDateTime() {
  const now = new Date();
  const options = {timeZone:'Asia/Jerusalem', hour12:false};
  document.getElementById("datetime").textContent = `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;
}
setInterval(updateDateTime,1000); updateDateTime();

// --- 注转 JSONs + 砖专 拽 砖专 驻 砖 ---
Promise.all([
  fetch('citiess.json').then(res => res.json()),
  fetch('areas.json').then(res => res.json()),
  fetch('cleaned_fine.json').then(res => res.json())
]).then(([citiesData, areasData, polygonsData]) => {
  //... (砖专 拽 砖专  砖)
});

function fitMapToMarkersAndPolygons(){
  const bounds = new google.maps.LatLngBounds();
  let hasAny = false;
  markers.forEach(m=>{ bounds.extend(m.getPosition()); hasAny=true; });
  activePolygons.forEach(p=>p.getPath().forEach(coord=>{ bounds.extend(coord); hasAny=true; }));
  if(hasAny) map.fitBounds(bounds); else { map.setCenter({lat:31.5,lng:34.8}); map.setZoom(7); }
}

window.initMap = initMap;
</script>

</body>
</html>
