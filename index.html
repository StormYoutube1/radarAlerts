<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="cropped_circle_image.png">
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; direction: rtl; }
#map { height: 100%; width: 100%; }
.info-box {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: black;
  color: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 400px;
  line-height: 1.4em;
  z-index: 1000;
  display: none;
  overflow-y: auto;
  max-height: 200px;
}
.logo-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  z-index: 1000;
  pointer-events: none;
  border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }

#sound-box {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #111;
  color: white;
  padding: 15px;
  border-radius: 10px;
  z-index: 1001;
  display: block;
  max-width: 320px;
}
/* ğŸ“Œ ×¢×™×¦×•×‘ ×œ×©×“×” ×—×™×¤×•×© ×¢×¨×™× */
#city-input {
  width: 100%;
  padding: 8px;
  border-radius: 6px;
  border: none;
  margin-top: 10px;
}
#city-suggestions {
  position: absolute;
  background: #222;
  color: white;
  border-radius: 8px;
  max-height: 200px;
  overflow-y: auto;
  margin-top: 2px;
  padding: 5px;
  width: calc(100% - 30px);
  z-index: 2000;
}
.suggestion-item {
  padding: 6px;
  border-bottom: 1px solid #444;
  cursor: pointer;
}
.suggestion-item:hover { background: #333; }
.suggestion-city { font-size: 14px; font-weight: bold; }
.suggestion-area { font-size: 12px; color: #aaa; }

/* ğŸ“Œ ×ª×¦×•×’×ª ×”×¢×¨×™× ×©× ×‘×—×¨×• */
#selected-cities {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  margin-top: 8px;
  max-height: 80px;
  overflow-y: auto;
}
.selected-city {
  background: #333;
  padding: 6px 10px;
  border-radius: 15px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 5px;
}
.selected-city span {
  cursor: pointer;
  color: #f55;
  font-weight: bold;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="logo-overlay"><img src="cropped_circle_image.png" alt="Logo"></div>
<div id="alert-box" class="info-box"></div>

<div id="sound-box">
  <div id="datetime" style="color:white;font-weight:bold;"></div>
  <label for="sound-select">×‘×—×¨ ×¦×œ×™×œ ×”×ª×¨×¢×”:</label>
  <select id="sound-select">
    <option value="none" selected>×œ×œ×</option>
    <option value="alert">×”×ª×¨×¢×”</option>
    <option value="calm">×¨×’×•×¢</option>
    <option value="siren">××–×¢×§×”</option>
    <option value="homefront">×¤×™×§×•×“ ×”×¢×•×¨×£</option>
    <option value="beep">×¦×¤×¦×•×£</option>
  </select>
  <button id="sound-btn" style="display:none;">×‘×“×•×§</button>

  <!-- --- ×ª×™×‘×ª ×”×¨×©××” ×œ×”×ª×¨××•×ª --- -->
  <label style="margin-top:10px;cursor:pointer;">
    <input type="checkbox" id="notifyPermission"> ××¤×©×¨ ×§×‘×œ×ª ×”×ª×¨×¢×•×ª ×‘×“×¤×“×¤×Ÿ
  </label>

  <!-- ğŸ“Œ ×ª×™×‘×ª ×—×™×¤×•×© ×™×™×©×•×‘×™× -->
  <input type="text" id="city-input" placeholder="×‘×—×¨ ×™×™×©×•×‘ ×œ×§×‘×œ ×¢×œ×™×• ×”×ª×¨×¢×”">
  <div id="city-suggestions"></div>
  <div id="selected-cities"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map;
let cityCoordinates = {};
let validAreas = [];
let markers = [];
let cityPolygons = {};
let activePolygons = [];
let audio = null;
let audioTimeout = null;
let alertActive = false;
let selectedCities = []; // ğŸ“Œ ×¢×¨×™× ×©×”××©×ª××© ×‘×—×¨

// --- ×¡××•× ×“×™× ---
const sounds = {
  calm: "calm.mp3",
  siren: "alert.mp3",
  homefront: "homefront.mp3",
  alert: "siren.mp3",
  beep: "beep.wav"
};

// --- ×”×¨×©××ª ×”×ª×¨××•×ª ---
let desktopPermissionGranted = false;
document.getElementById("notifyPermission").addEventListener("change", function() {
  if (this.checked && "Notification" in window) {
    Notification.requestPermission().then(permission => {
      desktopPermissionGranted = permission === "granted";
    });
  } else {
    desktopPermissionGranted = false;
  }
});

// --- ×”×¦×’×ª ×”×¦×¢×•×ª ×—×™×¤×•×© ---
function showSuggestions(inputValue, citiesData) {
  const suggestionsBox = document.getElementById("city-suggestions");
  suggestionsBox.innerHTML = "";

  if (!inputValue) return;

  let results = Object.values(citiesData.cities)
    .filter(c => c.he.startsWith(inputValue) && /^[×-×ª]/.test(c.he))
    .sort((a,b) => a.he.localeCompare(b.he))
    .slice(0, 8);

  results.forEach(cityObj => {
    const areaName = citiesData.areas[cityObj.area]?.he || "";
    const item = document.createElement("div");
    item.className = "suggestion-item";
    item.innerHTML = `
      <div class="suggestion-city">${cityObj.he}</div>
      <div class="suggestion-area">××–×•×¨ ${areaName}</div>
    `;
    item.addEventListener("click", () => addCity(cityObj));
    suggestionsBox.appendChild(item);
  });
}

// --- ×”×•×¡×¤×ª ×¢×™×¨ ×œ×¨×©×™××ª ×”×‘×—×™×¨×” ---
function addCity(cityObj) {
  if (selectedCities.length >= 5) {
    alert("××¤×©×¨ ×œ×‘×—×•×¨ ×¢×“ 5 ×™×™×©×•×‘×™× ×‘×œ×‘×“.");
    return;
  }
  if (selectedCities.find(c => c.he === cityObj.he)) return;

  selectedCities.push(cityObj);
  renderSelectedCities();
  document.getElementById("city-input").value = "";
  document.getElementById("city-suggestions").innerHTML = "";
}

// --- ×”×¦×’×ª ×¢×¨×™× ×©× ×‘×—×¨×• ---
function renderSelectedCities() {
  const container = document.getElementById("selected-cities");
  container.innerHTML = "";
  selectedCities.forEach(cityObj => {
    const el = document.createElement("div");
    el.className = "selected-city";
    el.innerHTML = `${cityObj.he} <span>Ã—</span>`;
    el.querySelector("span").addEventListener("click", () => {
      selectedCities = selectedCities.filter(c => c.he !== cityObj.he);
      renderSelectedCities();
    });
    container.appendChild(el);
  });
}

// --- ×”×¦×’×ª ×”×ª×¨××” ×‘×“×¡×§×˜×•×¤ ---
function showDesktopNotification(message, citiesInMessage, citiesData) {
  if (!desktopPermissionGranted) return;

  // ×¡×™× ×•×Ÿ ×œ×¤×™ ×¢×¨×™× ×©× ×‘×—×¨×• ğŸ“Œ
  if (selectedCities.length > 0) {
    const selectedNames = selectedCities.map(c => c.he);
    const match = citiesInMessage.some(c => selectedNames.includes(c));
    if (!match) return;
  }

  const firstLine = message.split("\n").find(l => l.trim() !== "");
  const title = firstLine || "ğŸš¨ ×”×ª×¨×¢×”";

  const areasSet = new Set();
  citiesInMessage.forEach(city => {
    const cityObj = Object.values(citiesData.cities).find(c => c.he === city);
    if (cityObj && cityObj.area) {
      const areaId = cityObj.area;
      const areaName = citiesData.areas[areaId]?.he;
      if (areaName) areasSet.add(areaName);
    }
  });

  const areasList = Array.from(areasSet).sort((a,b)=> a.localeCompare(b, 'he')).join(", ");
  const now = new Date();
  const options = { timeZone: 'Asia/Jerusalem', hour12:false };
  const dateTimeStr = `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;
  const body = `${areasList}\n\n${dateTimeStr}\n\n×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×`;

  new Notification(title, { body, icon: 'cropped_circle_image.png' });
}

// --- ××¤×” ---
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true
  });
}

// --- ×ª××¨×™×š ×•×©×¢×” ---
function updateDateTime() {
  const now = new Date();
  const options = {timeZone:'Asia/Jerusalem', hour12:false};
  document.getElementById("datetime").textContent =
    `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;
}
setInterval(updateDateTime,1000); updateDateTime();

// --- ×˜×¢×™× ×ª JSONs ---
Promise.all([
  fetch('citiess.json').then(res => res.json()),
  fetch('areas.json').then(res => res.json()),
  fetch('cleaned_fine.json').then(res => res.json())
]).then(([citiesData, areasData, polygonsData]) => {

  Object.values(citiesData.cities).forEach(c => { cityCoordinates[c.he]={lat:c.lat,lng:c.lng}; });
  validAreas = areasData;
  if(!map)initMap();

  // ×—×™×¤×•×© ×¢×¨×™×
  document.getElementById("city-input").addEventListener("input", e => {
    showSuggestions(e.target.value.trim(), citiesData);
  });

  // --- ×”×ª×¨×¢×•×ª Firebase ---
  db.ref("messages").on("child_added", snapshot=>{
    const data=snapshot.val();
    if(!data||!data.text||!data.timestamp) return;

    const msgTime=new Date(data.timestamp);
    const now=new Date();
    if(now-msgTime>60*1000) return;

    const message = data.text;
    let settlements = new Set();

    message.split("\n").forEach(line=>{
      if(line.startsWith("â€¢")){
        let parts=line.split(":");
        if(parts.length>1){
          parts[1].split(",").forEach(city=>{
            let cleanCity=city.replace(/\(.*?\)/g,"").trim();
            if(validAreas.includes(cleanCity)) settlements.add(cleanCity);
          });
        }
      }
    });

    const citiesInMessage = Array.from(settlements);
    if(citiesInMessage.length>0){
      showDesktopNotification(message, citiesInMessage, citiesData);
    }
  });

}).catch(err=>console.error('Error loading JSON files:', err));

window.initMap = initMap;
</script>
</body>
</html>
