<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="cropped_circle_image.png">
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; direction: rtl; }
#map { height: 100%; width: 100%; }
.info-box {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: black;
  color: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 400px;
  line-height: 1.4em;
  z-index: 1000;
  display: none;
  overflow-y: auto;
  max-height: 200px;
}
.logo-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  z-index: 1000;
  pointer-events: none;
  border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }

/* --- ××œ×‘×Ÿ ×¦×“ --- */
#sound-box {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #111;
  color: white;
  padding: 15px;
  border-radius: 10px;
  z-index: 1001;
  display: block;
  max-width: 320px;
  box-shadow: 0 0 10px rgba(0,0,0,0.6);
}
#sound-box section {
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid #333;
}
#sound-box label, #sound-box select, #sound-box button, #sound-box input {
  display: block;
  margin-top: 5px;
  width: 100%;
}
#sound-box button {
  margin-top: 8px;
  padding: 6px;
  border: none;
  background: #444;
  color: white;
  cursor: pointer;
  border-radius: 6px;
}
#sound-box button:hover { background:#666; }

/* --- ×—×™×¤×•×© ×™×™×©×•×‘ --- */
#city-search {
  width: 100%;
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #555;
  background: #222;
  color: white;
}
#city-search::placeholder { color: #aaa; }
#suggestions {
  background:#222;
  border:1px solid #555;
  border-radius:6px;
  margin-top:4px;
  max-height:150px;
  overflow-y:auto;
}
.suggestion-item {
  padding:6px;
  border-bottom:1px solid #333;
  cursor:pointer;
}
.suggestion-item:hover { background:#333; }
.suggestion-city { font-weight:bold; }
.suggestion-area { font-size:0.8em; color:#bbb; }

/* --- ×¨×©×™××ª ×¢×¨×™× × ×‘×—×¨×•×ª --- */
#selected-cities { margin-top:8px; }
.city-tag {
  display:inline-block;
  background:#333;
  color:white;
  padding:4px 8px;
  margin:2px;
  border-radius:12px;
  font-size:0.9em;
}
.city-tag button {
  background:none;
  border:none;
  color:#f55;
  margin-right:4px;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="logo-overlay"><img src="cropped_circle_image.png" alt="Logo"></div>
<div id="alert-box" class="info-box"></div>

<div id="sound-box">
  <section>
    <div id="datetime" style="color:white;font-weight:bold;"></div>
  </section>

  <section>
    <label for="sound-select">×‘×—×¨ ×¦×œ×™×œ ×”×ª×¨×¢×”:</label>
    <select id="sound-select">
      <option value="none" selected>×œ×œ×</option>
      <option value="alert">×”×ª×¨×¢×”</option>
      <option value="calm">×¨×’×•×¢</option>
      <option value="siren">××–×¢×§×”</option>
      <option value="homefront">×¤×™×§×•×“ ×”×¢×•×¨×£</option>
      <option value="beep">×¦×¤×¦×•×£</option>
    </select>
    <button id="sound-btn" style="display:none;">×‘×“×•×§</button>
  </section>

  <section>
    <label style="cursor:pointer;">
      <input type="checkbox" id="notifyPermission"> ××¤×©×¨ ×§×‘×œ×ª ×”×ª×¨×¢×•×ª ×‘×“×¤×“×¤×Ÿ
    </label>
  </section>

  <section>
    <input type="text" id="city-search" placeholder="×‘×—×¨ ×™×™×©×•×‘ ×œ×§×‘×œ ×¢×œ×™×• ×”×ª×¨×¢×”">
    <div id="suggestions"></div>
    <div id="selected-cities"></div>
  </section>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map;
let cityCoordinates = {};
let areasById = {};
let cityAreas = {};
let markers = [];
let cityPolygons = {};
let activePolygons = [];
let audio = null;
let audioTimeout = null;
let alertActive = false;
let userSelectedCities = [];

// --- ×¡××•× ×“×™× ---
const sounds = {
  calm: "calm.mp3",
  siren: "alert.mp3",
  homefront: "homefront.mp3",
  alert: "siren.mp3",
  beep: "beep.wav"
};

// --- ×”×¨×©××ª ×”×ª×¨××•×ª ---
let desktopPermissionGranted = false;
document.getElementById("notifyPermission").addEventListener("change", function() {
  if (this.checked && "Notification" in window) {
    Notification.requestPermission().then(permission => {
      desktopPermissionGranted = permission === "granted";
    });
  } else {
    desktopPermissionGranted = false;
  }
});

// --- ×”×¦×’×ª ×”×ª×¨××” ×‘×“×¡×§×˜×•×¤ ---
function showDesktopNotification(message, citiesInMessage, citiesData) {
  if (!desktopPermissionGranted) return;
  const firstLine = message.split("\n").find(l => l.trim() !== "");
  const title = firstLine || "ğŸš¨ ×”×ª×¨×¢×”";

  const areasSet = new Set();
  citiesInMessage.forEach(city => {
    const cityObj = citiesData.cities[city];
    if (cityObj && cityObj.area) {
      const areaId = cityObj.area;
      const areaName = citiesData.areas[areaId]?.he;
      if (areaName) areasSet.add(areaName);
    }
  });
  const areasList = Array.from(areasSet).sort((a,b)=> a.localeCompare(b,'he')).join(", ");

  const now = new Date();
  const options = { timeZone: 'Asia/Jerusalem', hour12:false };
  const dateTimeStr = `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;

  const body = `${areasList}\n\n${dateTimeStr}\n\n×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×`;
  new Notification(title, { body, icon:'cropped_circle_image.png' });
}

// --- ××¤×” ---
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true
  });
}

// --- ×¤×œ××© ××¨×§×¨×™× ---
function addFlashingMarker(lat, lng, message) {
  const marker = new google.maps.Marker({position: {lat, lng}, map, title: message});
  markers.push(marker);
  let visible = true;
  const flashInterval = setInterval(() => { marker.setVisible(visible); visible=!visible; }, 600);
  setTimeout(() => { marker.setMap(null); clearInterval(flashInterval); markers = markers.filter(m=>m!==marker); }, 10000);
}

// --- ×–×•× ××ª××™× ---
function fitMapToMarkersAndPolygons() {
  const bounds = new google.maps.LatLngBounds();
  let hasAny = false;
  markers.forEach(m => { bounds.extend(m.getPosition()); hasAny=true; });
  activePolygons.forEach(p => { p.getPath().forEach(coord => { bounds.extend(coord); hasAny=true; }); });
  if(hasAny) map.fitBounds(bounds);
  else { map.setCenter({lat: 31.5, lng: 34.8}); map.setZoom(7); }
}

// --- ×¡××•× ×“ ×›×¤×ª×•×¨ ---
const soundSelect = document.getElementById("sound-select");
const soundBtn = document.getElementById("sound-btn");
soundSelect.addEventListener("change", ()=> soundBtn.style.display = soundSelect.value==="none"?"none":"block");
soundBtn.addEventListener("click", ()=> {
  const selected = soundSelect.value;
  if(selected==="none") return;
  if(audio){ audio.pause(); audio=null; clearTimeout(audioTimeout); soundBtn.textContent="×‘×“×•×§"; }
  else { audio=new Audio(sounds[selected]); audio.loop=true; audio.play(); soundBtn.textContent="×¢×¦×•×¨";
    audioTimeout=setTimeout(()=>{ audio.pause(); audio=null; soundBtn.textContent="×‘×“×•×§"; },8000); }
});

// --- ×ª××¨×™×š ×•×©×¢×” ---
function updateDateTime() {
  const now = new Date();
  const options = {timeZone:'Asia/Jerusalem', hour12:false};
  document.getElementById("datetime").textContent =
    `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;
}
setInterval(updateDateTime,1000); updateDateTime();

// --- ×˜×¢×™× ×ª JSON ---
Promise.all([
  fetch('citiess.json').then(res => res.json()),
  fetch('areas.json').then(res => res.json()),
  fetch('cleaned_fine.json').then(res => res.json())
]).then(([citiesData, areasData, polygonsData]) => {
  Object.values(citiesData.cities).forEach(c => {
    cityCoordinates[c.he]={lat:c.lat,lng:c.lng};
    cityAreas[c.he]=areasData[c.area]?.he || "";
  });
  areasById = areasData;
  if(!map)initMap();
  let activeInfoWindow = null;

  // --- ×¤×•×œ×™×’×•× ×™× ---
  Object.keys(polygonsData).forEach(city=>{
    const pathCoords = polygonsData[city].map(coord=>({lat:coord[0], lng:coord[1]}));
    const polygon = new google.maps.Polygon({ paths:pathCoords, strokeColor:'#000', strokeOpacity:1, strokeWeight:2, fillColor:'red', fillOpacity:0.4, map:null });
    const infoWindow = new google.maps.InfoWindow({content: city});
    polygon.addListener('click', e=>{
      if(activeInfoWindow) activeInfoWindow.close();
      infoWindow.setPosition(e.latLng); infoWindow.open(map); activeInfoWindow=infoWindow;
    });
    cityPolygons[city] = polygon;
  });

  // --- ×—×™×¤×•×© ×™×™×©×•×‘ ---
  const searchInput = document.getElementById("city-search");
  const suggestionsBox = document.getElementById("suggestions");
  const selectedBox = document.getElementById("selected-cities");

  function renderSelected() {
    selectedBox.innerHTML="";
    userSelectedCities.forEach(city=>{
      const tag=document.createElement("div");
      tag.className="city-tag";
      tag.innerHTML=`<button onclick="removeCity('${city}')">Ã—</button>${city}`;
      selectedBox.appendChild(tag);
    });
  }
  window.removeCity=(city)=>{ userSelectedCities=userSelectedCities.filter(c=>c!==city); renderSelected(); };

  searchInput.addEventListener("input", ()=>{
    const val=searchInput.value.trim();
    suggestionsBox.innerHTML="";
    if(val.length<1) return;
    const regex=new RegExp("^"+val,"i");
    let matches=Object.keys(cityCoordinates).filter(c=>regex.test(c)).sort((a,b)=>a.localeCompare(b,'he')).slice(0,8);
    matches.forEach(city=>{
      const div=document.createElement("div");
      div.className="suggestion-item";
      div.innerHTML=`<div class="suggestion-city">${city}</div><div class="suggestion-area">${cityAreas[city]||""}</div>`;
      div.onclick=()=>{
        if(userSelectedCities.includes(city)) return;
        if(userSelectedCities.length>=5){ alert("× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×¢×“ 5 ×™×™×©×•×‘×™× ×‘×œ×‘×“."); return; }
        userSelectedCities.push(city); renderSelected(); searchInput.value=""; suggestionsBox.innerHTML="";
      };
      suggestionsBox.appendChild(div);
    });
  });

  // --- ×”×ª×¨×¢×•×ª ---
  db.ref("messages").on("child_added", snapshot=>{
    const data=snapshot.val();
    if(!data||!data.text||!data.timestamp) return;
    const msgTime=new Date(data.timestamp);
    const now=new Date();
    if(now-msgTime>60*1000) return;

    const message=data.text;
    let settlements=new Set();

    message.split("\n").forEach(line=>{
      if(line.startsWith("â€¢")){
        let parts=line.split(":");
        if(parts.length>1){
          parts[1].split(",").forEach(city=>{
            let cleanCity=city.replace(/\(.*?\)/g,"").trim();
            if(cityCoordinates[cleanCity]) settlements.add(cleanCity);
          });
        }
      }
    });

    const citiesInMessage=Array.from(settlements);

    // --- ×¡×™× ×•×Ÿ ×œ×¤×™ ×‘×—×™×¨×ª ×”××©×ª××© ---
    if(userSelectedCities.length>0){
      let match=false;
      citiesInMessage.forEach(city=>{
        if(userSelectedCities.includes(city)) match=true;
      });
      if(!match) return;
    }

    if(citiesInMessage.length>0){
      showDesktopNotification(message, citiesInMessage, citiesData);

      if(audio){ audio.pause(); audio=null; clearTimeout(audioTimeout); soundBtn.textContent="×‘×“×•×§"; }
      if(soundSelect.value!=="none"){ audio=new Audio(sounds[soundSelect.value]); audio.loop=true; audio.play(); soundBtn.textContent="×¢×¦×•×¨";
        audioTimeout=setTimeout(()=>{ audio.pause(); audio=null; soundBtn.textContent="×‘×“×•×§"; },8000); }

      alertActive=true;
      const alertBox=document.getElementById('alert-box');
      alertBox.innerHTML=message.replace(/\n/g,"<br>");
      alertBox.style.display='block';
      setTimeout(()=>{ alertBox.style.display='none'; alertActive=false; },10000);

      let currentPolygons=[];
      citiesInMessage.forEach(city=>{
        if(cityPolygons[city]){ cityPolygons[city].setMap(map); currentPolygons.push(cityPolygons[city]); }
        const coords=cityCoordinates[city]; if(coords) addFlashingMarker(coords.lat,coords.lng,message);
      });
      activePolygons.push(...currentPolygons);
      fitMapToMarkersAndPolygons();

      setTimeout(()=>{
        markers.forEach(m=>m.setMap(null)); markers=[];
        currentPolygons.forEach(p=>p.setMap(null));
        activePolygons=activePolygons.filter(p=>!currentPolygons.includes(p));
        fitMapToMarkersAndPolygons();
      },10000);
    }
  });
});
</script>
</body>
</html>
