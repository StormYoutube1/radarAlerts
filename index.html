<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>מפת התרעות ישראל</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; direction: rtl; }
#map { height: 100%; width: 100%; }
.info-box {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: black;
  color: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 400px;
  line-height: 1.4em;
  z-index: 1000;
  display: none;
  overflow-y: auto;
  max-height: 200px;
}
.logo-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  z-index: 1000;
  pointer-events: none;
  border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }

#sound-box {
  position: absolute;
  top: 20px;
  right: 20px;
  background: #111;
  color: white;
  padding: 15px;
  border-radius: 10px;
  z-index: 1001;
  display: block;
  max-width: 300px;
}
#sound-box label, #sound-box select, #sound-box button {
  display: block;
  margin-top: 5px;
}
#sound-box button {
  margin-top: 10px;
}
</style>
</head>
<body>
<div id="map"></div>
<div class="logo-overlay"><img src="path_to_original_image.jpg" alt="Logo"></div>
<div id="alert-box" class="info-box"></div>

<div id="sound-box">
  <div id="datetime" style="color:white;font-weight:bold;"></div>
  <label for="sound-select">בחר צליל התרעה:</label>
  <select id="sound-select">
    <option value="none" selected>ללא</option>
    <option value="alert">התרעה</option>
    <option value="calm">רגוע</option>
    <option value="siren">אזעקה</option>
    <option value="homefront">פיקוד העורף</option>
    <option value="beep">צפצוף</option>
  </select>
  <button id="sound-btn" style="display:none;">בדוק</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map;
let cityCoordinates = {};
let validAreas = [];
let markers = [];
let cityPolygons = {}; // ← לכל הפוליגונים

// סאונדים
const sounds = {
  calm: "ringtone-021-365652.mp3",
  siren: "israel-siren-sound-2023-made-with-Voicemod.mp3",
  homefront: "eas-alarm-iphone-alarm-262882.mp3",
  alert: "alarm-301729.mp3",
  beep: "mixkit-clear-announce-tones-2861.wav"
};
let audio = null;
let audioTimeout = null;
let alertActive = false;

// --- מפה והתרעות ---
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true
  });
}

// --- פונקציית פלאש למרקרים ---
function addFlashingMarker(lat, lng, message) {
  const marker = new google.maps.Marker({position: {lat, lng}, map, title: message});
  markers.push(marker);

  let visible = true;
  const flashInterval = setInterval(() => {
    marker.setVisible(visible);
    visible = !visible;
  }, 600);

  setTimeout(() => {
    marker.setMap(null);
    clearInterval(flashInterval);
    markers = markers.filter(m => m !== marker);
    fitMapToMarkers();
  }, 10000);

  fitMapToMarkers();
}

function fitMapToMarkers() {
  if (markers.length === 0) {
    map.setCenter({lat: 31.5, lng: 34.8});
    map.setZoom(7);
    return;
  }
  const bounds = new google.maps.LatLngBounds();
  markers.forEach(m => bounds.extend(m.getPosition()));
  map.fitBounds(bounds);
}

// --- סאונד כפתור ---
const soundSelect = document.getElementById("sound-select");
const soundBtn = document.getElementById("sound-btn");

function updateSoundButton() {
  if (soundSelect.value === "none") {
    soundBtn.style.display = "none";
  } else {
    soundBtn.style.display = "block";
    soundBtn.textContent = "בדוק";
  }
}
soundSelect.addEventListener("change", updateSoundButton);

function toggleSound() {
  const selected = soundSelect.value;
  if (selected === "none") return;

  if (audio) {
    audio.pause();
    audio = null;
    clearTimeout(audioTimeout);
    soundBtn.textContent = "בדוק";
  } else {
    audio = new Audio(sounds[selected]);
    audio.loop = true;
    audio.play();
    soundBtn.textContent = "עצור";

    audioTimeout = setTimeout(() => {
      audio.pause();
      audio = null;
      soundBtn.textContent = "בדוק";
    }, 8000);
  }
}
soundBtn.addEventListener("click", toggleSound);

// --- תאריך ושעה ---
function updateDateTime() {
  const now = new Date();
  const options = {timeZone: 'Asia/Jerusalem', hour12:false};
  const dateStr = now.toLocaleDateString('he-IL', options);
  const timeStr = now.toLocaleTimeString('he-IL', options);
  document.getElementById("datetime").textContent = `${dateStr} - ${timeStr}`;
}
setInterval(updateDateTime, 1000);
updateDateTime();

// --- טעינת JSONs ---
Promise.all([
  fetch('citiess.json').then(res => res.json()),
  fetch('areas.json').then(res => res.json()),
  fetch('cleaned_fine.json').then(res => res.json()) // ← טעינת פוליגונים
])
.then(([citiesData, areasData, polygonsData]) => {

  // --- מיפוי ערים לקואורדינטות ---
  Object.values(citiesData.cities).forEach(c => {
    cityCoordinates[c.he] = {lat: c.lat, lng: c.lng};
  });
  validAreas = areasData;

  if (!map) initMap();

  // --- יצירת פוליגונים לכל עיר ---
  Object.keys(polygonsData).forEach(city => {
    const pathCoords = polygonsData[city].map(coord => ({lat: coord[0], lng: coord[1]}));
    cityPolygons[city] = new google.maps.Polygon({
      paths: pathCoords,
      strokeColor: '#0000FF',
      strokeOpacity: 1.0,
      strokeWeight: 2,
      fillColor: 'red',
      fillOpacity: 0.4,
      map: null // לא מציגים עד להתרעה
    });
  });

  // --- שמירת התרעות Firebase ---
  db.ref("messages").on("child_added", snapshot => {
    const data = snapshot.val();
    if (!data || !data.text || !data.timestamp) return;

    const msgTime = new Date(data.timestamp);
    const now = new Date();
    if (now - msgTime > 60*1000) return;

    const message = data.text;
    let settlements = new Set();

    // --- חיפוש ערים לפי שורה ---
    message.split("\n").forEach(line => {
      if (line.startsWith("•")) {
        let parts = line.split(":");
        if (parts.length > 1) {
          let cities = parts[1].split(",");
          cities.forEach(city => {
            let cleanCity = city.replace(/\(.*?\)/g, "").trim();
            if (validAreas.includes(cleanCity)) settlements.add(cleanCity);
          });
        }
      }
    });

    // --- חיפוש אזורים משולבים ---
    const combined_areas_pattern = /(שדרות, איבים|אל עמארני, אל מסק|גבים, מכללת ספיר|זמרת, שובה|מבטחים, עמיעוז, ישע|מעגלים, גבעולים, מלילות|צוחר, אוהד|קריית גת, כרמי גת|חיפה - כרמל, הדר ועיר תחתית|חוף כינר, דוגה, דוגית|חוף כורסי, לבנון, חלוקים|חוף גולן, צאלון|אשדוד - א,ב,ד,ה|אשדוד - יא,יב,טו,יז,מרינה,סיטי|אשדוד - ח,ט,י,יג,יד,טז|אשדוד - ג,ו,ז)/g;
    const matches = message.match(combined_areas_pattern);
    if (matches) {
      matches.forEach(m => settlements.add(m));
    }

    const citiesInMessage = Array.from(settlements);
    if (citiesInMessage.length > 0) {

      // --- עצירת סאונד קיים והתחלה מחדש ---
      if (audio) {
        audio.pause();
        audio = null;
        clearTimeout(audioTimeout);
        soundBtn.textContent = "בדוק";
      }
      if (soundSelect.value !== "none") {
        audio = new Audio(sounds[soundSelect.value]);
        audio.loop = true;
        audio.play();
        soundBtn.textContent = "עצור";

        audioTimeout = setTimeout(() => {
          audio.pause();
          audio = null;
          soundBtn.textContent = "בדוק";
        }, 8000);
      }

      // --- הצגת הודעה ---
      alertActive = true;
      const alertBox = document.getElementById('alert-box');
      alertBox.innerHTML = message.replace(/\n/g, "<br>");
      alertBox.style.display = 'block';
      setTimeout(() => {
        alertBox.style.display = 'none';
        alertActive = false;
      }, 10000);

      // --- הצגת פוליגונים / מרקרים ---
      citiesInMessage.forEach(city => {
        if (cityPolygons[city]) {
          cityPolygons[city].setMap(map);
        } else {
          const coords = cityCoordinates[city];
          if (coords) addFlashingMarker(coords.lat, coords.lng, message);
        }
      });
    }
  });

})
.catch(err => console.error('Error loading JSON files:', err));

window.initMap = initMap;
</script>
</body>
</html>
