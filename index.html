<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>מפת התרעות ישראל</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html, body {
  height: 100%;
  margin: 0;
  font-family: Arial, sans-serif;
  direction: rtl;
}
#map {
  height: 100%;
  width: 100%;
}
.info-box {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: black;
  color: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 350px;
  line-height: 1.4em;
  z-index: 1000;
}
.info-box u { text-decoration: underline; font-weight: bold; }
.info-box i { font-style: italic; }
.logo-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  z-index: 1000;
  pointer-events: none;
  border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }
</style>
</head>
<body>
<div id="map"></div>
<div class="logo-overlay"><img src="path_to_original_image.jpg" alt="Logo"></div>
<div id="alert-box" class="info-box" style="display:none;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he">
</script>

<script>
// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map;
let cityCoordinates = {};
let knownCities = [];
let markers = [];

function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true,
    draggable: true,
    scrollwheel: true,
    disableDoubleClickZoom: false,
    keyboardShortcuts: true
  });
}

function addFlashingMarker(lat, lng, message) {
  const marker = new google.maps.Marker({position: {lat, lng}, map, title: message});
  markers.push(marker);

  // הבהוב
  let visible = true;
  const flashInterval = setInterval(() => {
    marker.setVisible(visible);
    visible = !visible;
  }, 600);

  setTimeout(() => {
    marker.setMap(null);
    clearInterval(flashInterval);
    markers = markers.filter(m => m !== marker);
    fitMapToMarkers();
  }, 10000);

  fitMapToMarkers();
}

function fitMapToMarkers() {
  if (markers.length === 0) {
    map.setCenter({lat: 31.5, lng: 34.8});
    map.setZoom(7);
    return;
  }
  const bounds = new google.maps.LatLngBounds();
  markers.forEach(m => bounds.extend(m.getPosition()));
  map.fitBounds(bounds);
}

// טעינת קואורדינטות
fetch('citiess.json')
  .then(response => response.json())
  .then(data => {
    const citiesData = data.cities;
    for (const key in citiesData) {
      cityCoordinates[citiesData[key].he] = {
        lat: citiesData[key].lat,
        lng: citiesData[key].lng
      };
    }
    knownCities = Object.keys(cityCoordinates);
    if (!map) initMap();

    db.ref("messages").on("child_added", snapshot => {
      const data = snapshot.val();
      if (!data || !data.text || !data.timestamp) return;

      const msgTime = new Date(data.timestamp);
      const now = new Date();
      if (now - msgTime > 60*1000) return; // רק דקה אחרונה

      const message = data.text;
      const cities = knownCities.filter(city => message.includes(city));
      console.log("הודעה חדשה:", message);
      console.log("ערים זוהו:", cities);
      
      if(cities.length > 0){
        const alertBox = document.getElementById('alert-box');
        // עיבוד טקסט HTML
        let htmlMessage = `<u>התרעה</u><br><br><i>${msgTime.toLocaleDateString('he-IL')} - ${msgTime.toLocaleTimeString('he-IL', {hour: '2-digit', minute:'2-digit'})}</i><br>`;
        cities.forEach(city => {
          htmlMessage += `• ${city}<br>`;
        });
        alertBox.innerHTML = htmlMessage;
        alertBox.style.display = 'block';
      }

      for (const city of cities) {
        const coords = cityCoordinates[city];
        if (coords) addFlashingMarker(coords.lat, coords.lng, message);
      }
    });
  })
  .catch(err => console.error('Error loading cities JSON:', err));

window.initMap = initMap;
</script>
</body>
</html>
