<!DOCTYPE html>
<html lang="he">
<head>
<meta charset="UTF-8">
<title>×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/png" href="cropped_circle_image.png">
<style>
html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; direction: rtl; }
#map { height: 100%; width: 100%; }

.info-box {
  position: absolute;
  bottom: 20px;
  right: 20px;
  background: black;
  color: white;
  padding: 10px;
  border-radius: 8px;
  max-width: 400px;
  line-height: 1.4em;
  z-index: 1000;
  display: none;
  overflow-y: auto;
  max-height: 200px;
}

.logo-overlay {
  position: absolute;
  top: 10px;
  left: 10px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
  z-index: 1000;
  pointer-events: none;
  border: 2px solid #fff;
}
.logo-overlay img { width: 100%; height: 100%; object-fit: cover; }

/* --- ×ª×™×‘×ª ×”×”×’×“×¨×•×ª --- */
#sound-box {
  position: absolute;
  top: 20px;
  right: 20px;
  background: rgba(25,25,25,0.95);
  color: white;
  padding: 18px;
  border-radius: 20px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.5);
  z-index: 1001;
  width: 320px;
  max-height: 520px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  gap: 14px;
  font-size: 14px;
}

/* ×›×•×ª×¨×•×ª ×§×˜×’×•×¨×™×” */
#sound-box .section-title {
  font-weight: bold;
  font-size: 15px;
  color: #ff0000; /* ××“×•× ×‘××§×•× ×¦×”×•×‘ */
  margin-bottom: 6px;
  border-bottom: 1px solid #444;
  padding-bottom: 3px;
}

/* ×©×“×•×ª ×•×˜×¤×¡×™× */
#sound-box label, 
#sound-box select, 
#sound-box button, 
#sound-box input[type="text"] {
  font-size: 14px;
}

#sound-box button {
  margin-top: 5px;
  padding: 6px 12px;
  border: none;
  border-radius: 8px;
  background: #333;
  color: white;
  cursor: pointer;
  transition: background 0.2s;
}
#sound-box button:hover { background: #555; }

#sound-box select, #city-search {
  width: 100%;
  padding: 6px 8px;
  border-radius: 8px;
  border: none;
  outline: none;
  background: #222;
  color: white;
}

/* ×¢×¨×™× × ×‘×—×¨×•×ª */
#selected-cities {
  display: flex;
  flex-direction: column;
  gap: 6px;
  max-height: 120px;
  overflow-y: auto;
  padding-right: 3px;
}
.selected-city {
  background: #2a2a2a;
  border-radius: 6px;
  padding: 5px 8px;
  font-size: 14px;
  line-height: 1.3em;
}
.selected-city strong { display: block; }
.selected-city small { color: #aaa; font-size: 12px; display: block; margin-top: 2px; }
.selected-city span.remove {
  cursor: pointer;
  color: #f55;
  margin-right: 6px;
  font-weight: bold;
  float: left;
}

/* ×”×¦×¢×•×ª ×—×™×¤×•×© */
#city-suggestions {
  background: rgba(34,34,34,0.95);
  border-radius: 8px;
  max-height: 180px;
  overflow-y: auto;
  padding: 5px;
  width: 100%;
  position: relative;
  z-index: 2000;
}
.suggestion-item {
  padding: 6px 8px;
  cursor: pointer;
  border-radius: 6px;
  margin-bottom: 2px;
}
.suggestion-item:hover { background: #444; }
.suggestion-city { font-weight: bold; }
.suggestion-area { font-size: 12px; color: #aaa; }

/* ×¨×¡×¤×•× ×¡×™×‘×™×•×ª */
@media (max-width: 600px) {
    #map,
    #sound-box,
    #alert-box {
        display: none !important;
    }

    
    #sound-box {
        width: 90%;
        right: 50%;
        transform: translateX(50%);
        top: auto;
        bottom: 20px;
        max-height: 50vh;
    }
    .logo-overlay {
        top: 10px;
        right: 10px;
        left: auto;
        width: 50px;
        height: 50px;
    }
    #alert-box {
        bottom: 90px;
        right: 10px;
        max-width: 90%;
    }
    #city-suggestions,
    #city-search,
    #selected-cities {
        display: none;
    }
    #sound-box label input#notifyPermission {
        display: none;
    }
    #sound-box label:has(input#notifyPermission) {
        display: none;
    }
    #sound-box .section-title {
        display: none;
    }
    #sound-box .section-title:first-of-type {
        display: block;
    }
}
@media (max-width: 900px) and (min-width: 601px) {
    #sound-box {
        width: 300px;
        right: 10px;
        top: auto;
        bottom: 20px;
        max-height: 70vh;
    }
    .logo-overlay {
        top: 10px;
        right: 10px;
        left: auto;
    }
}
@media (min-width: 901px) {
    #sound-box {
        right: 20px;
        top: 20px;
        width: 320px;
        max-height: 520px;
    }
}
</style>
</head>
<body>

<script>
(function() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if(isMobile){
        document.body.innerHTML = `
            <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; text-align:center; font-family:Arial,sans-serif; padding:20px; gap:12px;">
                <h2 style="font-size:22px; line-height:1.3;">âš ï¸ ×”××ª×¨ ××™× ×• ×–××™×Ÿ ×‘××›×©×™×¨×™× × ×™×™×“×™×</h2>
                <p style="font-size:16px; line-height:1.4; max-width:300px;">×œ×¦×¢×¨× ×•, ×—×œ×§ ××”×¤×•× ×§×¦×™×•×ª ×œ× ×ª×•××›×•×ª ×‘××•×‘×™×™×œ.</p>
                <p style="font-size:16px; line-height:1.4; max-width:300px;">×× × ×¤×ª×— ××ª ×”××ª×¨ ×‘××—×©×‘ ×›×“×™ ×œ×¨××•×ª ××•×ª×• ×‘××œ×•××•.</p>
                <button onclick="window.location.href='platform.html'" 
                        style="margin-top:10px; padding:12px 24px; font-size:16px; border:none; border-radius:8px; background:#333; color:white; cursor:pointer; max-width:250px; width:100%;">
                        ×œ×¤×œ×˜×¤×•×¨××•×ª ×©×œ× ×•
                </button>
            </div>
        `;
    }
})();
</script>
<div id="map"></div>
<div class="logo-overlay"><img src="cropped_circle_image.png" alt="Logo"></div>
<div id="alert-box" class="info-box"></div>

<div id="sound-box">
  <div id="datetime" style="color:white;font-weight:bold;text-align:center;"></div>

  <div class="section-title">ğŸ”Š | ×¦×œ×™×œ×™×</div>
  <label style="cursor:pointer; display:flex; align-items:center; gap:5px;">
    <input type="checkbox" id="enable-sound"> ×”×¤×¢×œ ×¦×œ×™×œ ×”×ª×¨×¢×”
  </label>
  <div style="display:flex; align-items:center; gap:5px; flex-direction:row-reverse;">
    <button id="sound-btn">â–¶</button>
    <select id="sound-select">
      <option value="alert">×”×ª×¨×¢×”</option>
      <option value="calm">×¨×’×•×¢</option>
      <option value="siren">××–×¢×§×”</option>
      <option value="homefront">×¤×™×§×•×“ ×”×¢×•×¨×£</option>
      <option value="beep">×¦×¤×¦×•×£</option>
    </select>
  </div>

  <div class="section-title">ğŸ”” | ×”×ª×¨××•×ª ×“×¤×“×¤×Ÿ</div>
  <label style="margin-top:5px;cursor:pointer;">
    <input type="checkbox" id="notifyPermission"> ××¤×©×¨ ×§×‘×œ×ª ×”×ª×¨×¢×•×ª ×‘×“×¤×“×¤×Ÿ
  </label>

  <div class="section-title">ğŸ” | ×¡×™× ×•×Ÿ ×œ×¤×™ ×™×™×©×•×‘</div>
  <input type="text" id="city-search" placeholder="×”×§×œ×“ ×™×™×©×•×‘...">
  <div id="city-suggestions"></div>
  <div id="selected-cities"></div>

  <div style="margin-top:auto; text-align:center; padding-top:10px;">
      <div style="border-top:1px solid #555; padding-top:5px; color:#ff4444; font-weight:bold;">
          ×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×
      </div>
      <div style="border-top:1px solid #555; padding-top:10px; display:flex; justify-content:center; margin-top:10px;">
          <button onclick="window.location.href='platform.html'">×œ×¤×œ×˜×¤×•×¨××•×ª ×©×œ× ×•</button>
      </div>
  </div>
</div>

<script>
function renderDateTimeBox() {
    const days = ["×¨××©×•×Ÿ","×©× ×™","×©×œ×™×©×™","×¨×‘×™×¢×™","×—××™×©×™","×©×™×©×™","×©×‘×ª"];
    const now = new Date();
    const day = days[now.getDay()];
    const date = now.toLocaleDateString("he-IL", { day: "2-digit", month: "2-digit", year: "numeric" });
    const time = now.toLocaleTimeString("he-IL", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    document.getElementById("datetime").innerText = `${day} | ${date} | ${time}`;
}
setInterval(renderDateTimeBox, 1000);
renderDateTimeBox();
</script>
</body>
</html>


<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script async defer
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCaGWR6n5uru3rd4sqtGNR-P-ZiYh5R7XI&language=he&callback=initMap">
</script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCkrbB17xURNXcJuRv1s6gK2Es-nPXJTIo",
  authDomain: "radar-7c02f.firebaseapp.com",
  databaseURL: "https://radar-7c02f-default-rtdb.firebaseio.com",
  projectId: "radar-7c02f",
  storageBucket: "radar-7c02f.firebasestorage.app",
  messagingSenderId: "985232578682",
  appId: "1:985232578682:web:f9e4326411aced7c4583c3",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let map, cityCoordinates = {}, validAreas = [], markers = [], cityPolygons = {}, activePolygons = [], audio = null, audioTimeout = null, alertActive = false, alertTimeout = null;
let desktopPermissionGranted = false;
let selectedCities = [];

const sounds = { calm: "calm.mp3", siren: "alert.mp3", homefront: "homefront.mp3", alert: "siren.mp3", beep: "beep.wav" };

// --- ×”×¨×©××ª ×”×ª×¨××•×ª ---
const notifyCheckbox = document.getElementById("notifyPermission");
function updateNotifyCheckbox() {
  desktopPermissionGranted = Notification.permission === "granted";
  notifyCheckbox.checked = false;
  notifyCheckbox.disabled = Notification.permission !== "default" && Notification.permission !== "granted";
}
notifyCheckbox.addEventListener("change", function() {
  if (this.checked && "Notification" in window) {
    Notification.requestPermission().then(permission => {
      desktopPermissionGranted = permission === "granted";
      if (!desktopPermissionGranted) this.checked = false;
    });
  } else {
    desktopPermissionGranted = false;
  }
});
updateNotifyCheckbox();

// --- ×”×¦×’×ª ×”×ª×¨××” ×‘×“×¡×§×˜×•×¤ ---
function showDesktopNotification(message, citiesInMessage, citiesData) {
  if (!desktopPermissionGranted) return;

  const firstLine = message.split("\n").find(l => l.trim() !== "");
  const title = firstLine || "ğŸš¨ ×”×ª×¨×¢×”";

  const areasSet = new Set();
  citiesInMessage.forEach(city => {
    const cityObj = Object.values(citiesData.cities).find(c => c.he === city);
    if (cityObj && cityObj.area) {
      const areaId = cityObj.area;
      const areaName = citiesData.areas[areaId]?.he;
      if (areaName) areasSet.add(areaName);
    }
  });
  const areasList = Array.from(areasSet).sort((a,b)=> a.localeCompare(b, 'he')).join(", ");

  const now = new Date();
  const options = { timeZone: 'Asia/Jerusalem', hour12:false };
  const dateTimeStr = `${now.toLocaleDateString('he-IL', options)} - ${now.toLocaleTimeString('he-IL', options)}`;

  const body = `${areasList}\n\n${dateTimeStr}\n\n×¨×“××¨ ğŸ“¡ - ×¦×‘×¢ ××“×•×`;

  const notification = new Notification(title, { body: body, icon: 'cropped_circle_image.png' });
  notification.onclick = () => window.focus();
}

// --- ××¤×” ---
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: {lat: 31.5, lng: 34.8},
    zoom: 7,
    mapTypeId: 'roadmap',
    disableDefaultUI: true
  });
}

// --- ×¤×œ××© ××¨×§×¨×™× ---
function addFlashingMarker(lat, lng, message) {
  const marker = new google.maps.Marker({position: {lat, lng}, map, title: message});
  markers.push(marker);
  let visible = true;
  const flashInterval = setInterval(() => { marker.setVisible(visible); visible = !visible; }, 600);
  setTimeout(() => { marker.setMap(null); clearInterval(flashInterval); markers = markers.filter(m => m!==marker); }, 10000);
}

// --- ×¡××•× ×“ ---
const enableSoundCheckbox = document.getElementById("enable-sound");
const soundSelect = document.getElementById("sound-select");
const soundBtn = document.getElementById("sound-btn");
let audioTimeoutLocal = null;

// ×›×¤×ª×•×¨ "×‘×“×•×§" ××ª×—×™×œ/×¢×•×¦×¨
function toggleSound() {
  const selected = soundSelect.value;
  if(!selected || !enableSoundCheckbox.checked) return;

  if(audio){ 
    audio.pause(); audio=null; clearTimeout(audioTimeoutLocal); soundBtn.textContent="â–¶"; 
  } else { 
    audio=new Audio(sounds[selected]); audio.loop=true; audio.play(); soundBtn.textContent="â¸";
    audioTimeoutLocal=setTimeout(()=>{ if(audio){ audio.pause(); audio=null; soundBtn.textContent="â–¶"; } },8000);
  }
}
soundBtn.addEventListener("click", toggleSound);
function updateSoundButton() { soundBtn.style.display = soundSelect.value ? "block" : "none"; soundBtn.textContent="â–¶"; }
soundSelect.addEventListener("change", updateSoundButton);
updateSoundButton();



// --- ×˜×¢×™× ×ª JSONs ---
Promise.all([
  fetch('citiess.json').then(res => res.json()),
  fetch('areas.json').then(res => res.json()),
  fetch('cleaned_fine.json').then(res => res.json())
]).then(([citiesData, areasData, polygonsData]) => {

  Object.values(citiesData.cities).forEach(c => { cityCoordinates[c.he]={lat:c.lat,lng:c.lng}; });
  validAreas = areasData;
  if(!map)initMap();
  let activeInfoWindow = null;

  Object.keys(polygonsData).forEach(city=>{
    const pathCoords = polygonsData[city].map(coord=>({lat:coord[0], lng:coord[1]}));
    const polygon = new google.maps.Polygon({ paths: pathCoords, strokeColor:'#000', strokeOpacity:1.0, strokeWeight:2, fillColor:'red', fillOpacity:0.4, map:null });
    const infoWindow = new google.maps.InfoWindow({content: city});
    polygon.addListener('click', e=>{
      if(activeInfoWindow) activeInfoWindow.close();
      infoWindow.setPosition(e.latLng); infoWindow.open(map); activeInfoWindow = infoWindow;
    });
    cityPolygons[city] = polygon;
  });

  db.ref("messages").on("child_added", snapshot=>{
    const data=snapshot.val();
    if(!data||!data.text||!data.timestamp) return;
    const msgTime=new Date(data.timestamp); if(new Date()-msgTime>60000) return;

    const message = data.text;
    let settlements = new Set();

    message.split("\n").forEach(line=>{
      if(line.startsWith("â€¢")){
        let parts=line.split(":");
        if(parts.length>1){
          parts[1].split(",").forEach(city=>{
            let cleanCity=city.replace(/\(.*?\)/g,"").trim();
            if(validAreas.includes(cleanCity)) settlements.add(cleanCity);
          });
        }
      }
    });

    const citiesInMessage = Array.from(settlements);

    let showAlert = false;
    if (selectedCities.length === 0) {
      showAlert = true;
    } else {
      showAlert = citiesInMessage.some(city => selectedCities.includes(city));
    }

    if (showAlert && citiesInMessage.length > 0) {

      // --- ×¢×¦×™×¨×ª ×”×ª×¨×¢×” ×§×•×“××ª ×× ×§×™×™××ª ---
      if(alertActive || audio){
        if(audio){ audio.pause(); audio=null}
        if(audioTimeout){ clearTimeout(audioTimeout); audioTimeout = null; }
        if(audioTimeoutLocal){ clearTimeout(audioTimeoutLocal); audioTimeoutLocal = null; }
        const alertBox = document.getElementById('alert-box');
        alertBox.style.display='none';
        alertActive=false;
        markers.forEach(m=>m.setMap(null));
        markers=[];
        activePolygons.forEach(p=>p.setMap(null));
        activePolygons=[];
        clearTimeout(alertTimeout);
      }

      showDesktopNotification(message, citiesInMessage, citiesData);

      if(soundSelect.value !== "none" && enableSoundCheckbox.checked){
        audio=new Audio(sounds[soundSelect.value]);
        audio.loop=true;
        audio.play();
        soundBtn.textContent="â¸";
        audioTimeout=setTimeout(()=>{ audio.pause(); audio=null; soundBtn.textContent="â–¶"; },8000);
      }

      alertActive = true;
      const alertBox = document.getElementById('alert-box');
      alertBox.innerHTML = message.replace(/\n/g,"<br>");
      alertBox.style.display='block';
      const soundBox = document.getElementById('sound-box');
      soundBox.style.display = 'none';
      alertTimeout = setTimeout(()=>{
        alertBox.style.display='none';
        alertActive=false;
        soundBox.style.display = 'flex';
      },10000);

      let currentPolygons = [];
      citiesInMessage.forEach(city=>{
        if(cityPolygons[city]){ cityPolygons[city].setMap(map); currentPolygons.push(cityPolygons[city]); }
        const coords = cityCoordinates[city];
        if(coords) addFlashingMarker(coords.lat, coords.lng, message);
      });

      activePolygons.push(...currentPolygons);
      fitMapToMarkersAndPolygons();

      setTimeout(()=>{
        markers.forEach(m=>m.setMap(null));
        markers=[];
        currentPolygons.forEach(p=>p.setMap(null));
        activePolygons=activePolygons.filter(p=>!currentPolygons.includes(p));
        fitMapToMarkersAndPolygons();
      },10000);
    }
  });

  // --- ×—×™×¤×•×© ×¢×¨×™× + ×”×¦×¢×•×ª ---
  const searchInput = document.getElementById("city-search");
  const suggestionsBox = document.getElementById("city-suggestions");
  const selectedCitiesContainer = document.getElementById("selected-cities");

  function renderSuggestions(list){
    suggestionsBox.innerHTML = "";
    list.slice(0,8).forEach(c=>{
      const areaName = c.area && citiesData.areas[c.area] ? citiesData.areas[c.area].he : "";
      const div = document.createElement("div");
      div.className="suggestion-item";
      div.innerHTML = `<div class="suggestion-city">${c.he}</div>${areaName ? `<div class="suggestion-area">××–×•×¨ ${areaName}</div>` : ""}`;
      div.addEventListener("click", ()=>{
        if(selectedCities.length>=5){ alert("× ×™×ª×Ÿ ×œ×‘×—×•×¨ ×¢×“ 5 ×¢×¨×™× ×‘×œ×‘×“"); return; }
        selectedCities.push(c.he);
        renderSelectedCities(citiesData, citiesData.areas);
        searchInput.value="";
        suggestionsBox.innerHTML="";
      });
      suggestionsBox.appendChild(div);
    });
  }
   

  function renderSelectedCities(citiesData, areasData){
    selectedCitiesContainer.innerHTML="";
    selectedCities.forEach(cityName=>{
      const cityObj = Object.values(citiesData.cities).find(c => c.he === cityName);
      const areaName = cityObj && areasData[cityObj.area] ? areasData[cityObj.area].he : "";
      const div = document.createElement("div");
      div.className="selected-city";
      div.innerHTML = `<span class="remove">Ã—</span><strong>${cityName}</strong>${areaName ? `<small>××–×•×¨ ${areaName}</small>` : ""}`;
      div.querySelector(".remove").onclick = ()=>{
        selectedCities = selectedCities.filter(c=>c!==cityName);
        renderSelectedCities(citiesData, areasData);
      }
      selectedCitiesContainer.appendChild(div);
    });
  }

  searchInput.addEventListener("input", ()=>{
    const val = searchInput.value.trim();
    if(val===""){ suggestionsBox.innerHTML=""; return; }
    const filtered = Object.values(citiesData.cities).filter(c=>c.he.startsWith(val));
    renderSuggestions(filtered);
  });

}).catch(err=>console.error('Error loading JSON files:', err));

function fitMapToMarkersAndPolygons(){
  const bounds = new google.maps.LatLngBounds();
  let hasAny = false;
  markers.forEach(m=>{ bounds.extend(m.getPosition()); hasAny=true; });
  activePolygons.forEach(p=>p.getPath().forEach(coord=>{ bounds.extend(coord); hasAny=true; }));
  if(hasAny) map.fitBounds(bounds); else { map.setCenter({lat:31.5,lng:34.8}); map.setZoom(7); }
}

db.ref("api_alerts").on("child_added", snapshot => {
    const data = snapshot.val();
    if(!data || !data.title || !data.data) return;
    if(data.title !== "×‘×“×§×•×ª ×”×§×¨×•×‘×•×ª ×¦×¤×•×™×•×ª ×œ×”×ª×§×‘×œ ×”×ª×¨×¢×•×ª ×‘××™×–×•×¨×™× ×”×‘××™×:") return;

    const citiesList = data.data; // ×¨×©×™××ª ×©××•×ª ×¢×¨×™×
    let polygonCoords = [];

    citiesList.forEach(cityName => {
        const cityObj = polygonsData[cityName]; // ××‘×•×¡×¡ ×¢×œ cleaned_fine.json
        if(cityObj && cityObj.length){
            cityObj.forEach(coord => polygonCoords.push({lat: coord[0], lng: coord[1]}));
        } else if(cityCoordinates[cityName]) {
            polygonCoords.push(cityCoordinates[cityName]);
        }
    });

    // ×× ×™×© ×œ×¤×—×•×ª 3 × ×§×•×“×•×ª, × ×‘× ×” ×¤×•×œ×™×’×•×Ÿ
    if(polygonCoords.length >= 3){
        // ×¡×•×’×¨×™× ××ª ×”×¤×•×œ×™×’×•×Ÿ
        if(polygonCoords[0] !== polygonCoords[polygonCoords.length - 1]){
            polygonCoords.push(polygonCoords[0]);
        }

        const alertPolygon = new google.maps.Polygon({
            paths: polygonCoords,
            strokeColor: "#8000FFFF",
            strokeOpacity: 1.0,
            strokeWeight: 2,
            fillColor: "red",
            fillOpacity: 0.4,
            map: map
        });

        activePolygons.push(alertPolygon);

        // ××ª×× ××ª ×”××¤×” ×œ× ×§×•×“×•×ª ×”×¤×•×œ×™×’×•×Ÿ
        const bounds = new google.maps.LatLngBounds();
        polygonCoords.forEach(c => bounds.extend(c));
        map.fitBounds(bounds);

        // ××—×™×§×ª ×”×¤×•×œ×™×’×•×Ÿ ××—×¨×™ 10 ×©× ×™×•×ª
        setTimeout(()=>{
            alertPolygon.setMap(null);
            activePolygons = activePolygons.filter(p => p !== alertPolygon);
        }, 10000);
    }
});

window.initMap = initMap;
</script>
</body>
</html>

